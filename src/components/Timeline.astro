---
import TimelineItem from "../components/TimelineItem.astro";
import { getTimeline } from "../scripts/airtable";
import type { TimelineItem as TimelineItemType } from "../types";
const timelineData = await getTimeline();

let perYear: Record<string, TimelineItemType[]> = {};
timelineData.forEach((d) => {
  const year = d.date.split("-")[0];
  if (!perYear[year]) {
    perYear[year] = [];
  }
  perYear[year].push(d);
});
const sortedYears = Object.keys(perYear).sort(
  (a, b) => parseInt(b) - parseInt(a),
);

// Count per category
const typeCounts: Record<string, number> = {};
timelineData.forEach((d) => {
  typeCounts[d.type] = (typeCounts[d.type] || 0) + 1;
});
---

<div id="timeline" class="max-w-2xl m-auto text-left">
  <nav class="category-nav">
    <button class="category-chip active" data-type="article">
      <div class="i-heroicons-document-text-20-solid chip-icon"></div>
      <span class="chip-label">記事</span> <span class="chip-count">{typeCounts.article}</span>
    </button>
    <button class="category-chip active" data-type="presentation">
      <div class="i-heroicons-presentation-chart-bar-20-solid chip-icon"></div>
      <span class="chip-label">発表</span> <span class="chip-count">{typeCounts.presentation}</span>
    </button>
    <button class="category-chip active" data-type="paper">
      <div class="i-heroicons-academic-cap-20-solid chip-icon"></div>
      <span class="chip-label">論文</span> <span class="chip-count">{typeCounts.paper}</span>
    </button>
    <button class="category-chip active" data-type="podcast">
      <div class="i-heroicons-radio-20-solid chip-icon"></div>
      <span class="chip-label">音声</span> <span class="chip-count">{typeCounts.podcast}</span>
    </button>
  </nav>

  <nav class="year-nav">
    {sortedYears.map((year) => (
      <a href={`#year-${year}`} class="year-chip" data-year={year}>{year}<span class="chip-count">{perYear[year].length}</span></a>
    ))}
  </nav>

  <div class="flex flex-col gap-y-6">
    {
      sortedYears.map((year) => (
        <div id={`year-${year}`} class="year-section">
          <h3 class="text-center text-base font-semibold opacity-60">{year}</h3>
          {perYear[year].map((d) => (
            <div data-type={d.type} class="timeline-item-wrapper">
              <TimelineItem
                url={d.url}
                date={d.date}
                type={d.type}
                title={d.title}
                description={d.description}
              />
            </div>
          ))}
        </div>
      ))
    }
  </div>
</div>

<style lang="scss">
  #timeline {
    min-height: 100vh;
  }

  .category-nav {
    display: flex;
    justify-content: center;
    gap: 1.2em;
    margin-bottom: 1.8em;

    .category-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35em;
      padding: 0.3em 0.9em;
      font-size: 0.85em;
      font-weight: 400;
      color: var(--c-text);
      background: none;
      border: 1.5px solid transparent;
      border-radius: 9999px;
      cursor: pointer;
      opacity: 0.35;
      transition: all 250ms ease;
      letter-spacing: 0.06em;

      .chip-icon {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }

      .chip-label {
        display: none;

        @media (min-width: 480px) {
          display: inline;
        }
      }

      .chip-count {
        font-size: 0.75em;
        opacity: 0.45;
        margin-left: 0.15em;
        display: none;

        @media (min-width: 480px) {
          display: inline;
        }
      }

      &:hover {
        opacity: 0.6;
        border-color: var(--c-border);
        background: rgba(0, 0, 0, 0.03);
      }

      &.active {
        opacity: 0.8;
        border-color: var(--c-border);
        color: var(--c-text);
      }
    }
  }

  .timeline-item-wrapper {
    &.filter-hidden {
      display: none;
    }
  }

  .year-section {
    &.filter-hidden {
      display: none;
    }
  }

  .year-nav {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.35em;
    margin-bottom: 2.5em;

    .year-chip {
      display: inline-flex;
      align-items: baseline;
      padding: 0.25em 0.7em;
      font-size: 0.8em;
      font-weight: 500;
      color: var(--c-text);
      opacity: 0.45;
      text-decoration: none;
      border-radius: 9999px;
      border: 1.5px solid transparent;
      transition: all 250ms ease;
      letter-spacing: 0.02em;

      &:hover {
        opacity: 1;
        border-color: var(--c-border);
        background: rgba(0, 0, 0, 0.04);
      }

      .chip-count {
        font-size: 0.75em;
        opacity: 0.45;
        margin-left: 0.3em;
        min-width: 1.5em;
        text-align: center;
        display: none;

        @media (min-width: 480px) {
          display: inline-block;
        }
      }

      &.active {
        opacity: 0.8;
        border-color: var(--c-border);
        color: var(--c-text);
      }

      &.disabled {
        opacity: 0.2;
        pointer-events: none;
      }
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const yearChips =
      document.querySelectorAll<HTMLAnchorElement>(".year-chip");
    const yearSections =
      document.querySelectorAll<HTMLElement>(".year-section");
    const categoryChips =
      document.querySelectorAll<HTMLButtonElement>(".category-chip");

    // --- Shared helpers ---

    function allYearsActive() {
      return Array.from(yearChips).every((c) =>
        c.classList.contains("active"),
      );
    }

    function isOnlyYearActive(chip: HTMLAnchorElement) {
      return (
        chip.classList.contains("active") &&
        Array.from(yearChips).every(
          (c) => c === chip || !c.classList.contains("active"),
        )
      );
    }

    function allCategoriesActive() {
      return Array.from(categoryChips).every((c) =>
        c.classList.contains("active"),
      );
    }

    function isOnlyCategoryActive(chip: HTMLButtonElement) {
      return (
        chip.classList.contains("active") &&
        Array.from(categoryChips).every(
          (c) => c === chip || !c.classList.contains("active"),
        )
      );
    }

    // --- Visibility ---

    function updateVisibility() {
      const activeTypes = new Set<string>();
      categoryChips.forEach((chip) => {
        if (chip.classList.contains("active")) {
          activeTypes.add(chip.dataset.type!);
        }
      });

      const activeYears = new Set<string>();
      yearChips.forEach((chip) => {
        if (chip.classList.contains("active")) {
          activeYears.add(chip.dataset.year!);
        }
      });
      const filterByYear = !allYearsActive();

      // Toggle individual items (by category)
      document
        .querySelectorAll<HTMLElement>(".timeline-item-wrapper")
        .forEach((item) => {
          item.classList.toggle(
            "filter-hidden",
            !activeTypes.has(item.dataset.type!),
          );
        });

      // Toggle year sections and update year counts
      yearSections.forEach((section) => {
        const year = section.id.replace("year-", "");
        const yearChip = document.querySelector<HTMLAnchorElement>(
          `.year-chip[data-year="${year}"]`,
        );

        // Count visible items by category (always, for chip counts)
        const items = section.querySelectorAll(".timeline-item-wrapper");
        const visibleCount = Array.from(items).filter(
          (item) => !item.classList.contains("filter-hidden"),
        ).length;

        // Update the year chip count and disable if zero
        if (yearChip) {
          const countEl = yearChip.querySelector(".chip-count");
          if (countEl) {
            countEl.textContent = String(visibleCount);
            (countEl as HTMLElement).style.visibility = visibleCount > 0 ? "" : "hidden";
          }
          yearChip.classList.toggle("disabled", visibleCount === 0);
        }

        // Hide section if year-filtered out, or if all items are category-hidden
        if (filterByYear && !activeYears.has(year)) {
          section.classList.add("filter-hidden");
        } else {
          section.classList.toggle("filter-hidden", visibleCount === 0);
        }
      });
    }

    function scrollToTimeline() {
      const el = document.getElementById("timeline")!;
      const top = el.getBoundingClientRect().top + window.scrollY - 40;
      window.scrollTo({ top, behavior: "smooth" });
    }

    // --- Year chip click: filter (not scroll) ---

    // Start with all years active
    yearChips.forEach((chip) => chip.classList.add("active"));

    yearChips.forEach((chip) => {
      chip.addEventListener("click", (e) => {
        e.preventDefault();
        if (allYearsActive()) {
          yearChips.forEach((c) => c.classList.remove("active"));
          chip.classList.add("active");
        } else if (isOnlyYearActive(chip)) {
          yearChips.forEach((c) => c.classList.add("active"));
        } else {
          yearChips.forEach((c) => c.classList.remove("active"));
          chip.classList.add("active");
        }
        updateVisibility();
      });
    });

    // --- Category chip click ---

    categoryChips.forEach((chip) => {
      chip.addEventListener("click", () => {
        if (allCategoriesActive()) {
          categoryChips.forEach((c) => c.classList.remove("active"));
          chip.classList.add("active");
        } else if (isOnlyCategoryActive(chip)) {
          categoryChips.forEach((c) => c.classList.add("active"));
        } else {
          categoryChips.forEach((c) => c.classList.remove("active"));
          chip.classList.add("active");
        }
        updateVisibility();
        scrollToTimeline();
      });
    });
  });
</script>
