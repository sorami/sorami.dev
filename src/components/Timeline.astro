---
import TimelineItem from "../components/TimelineItem.astro";
import { getTimeline } from "../scripts/airtable";
import type { TimelineItem as TimelineItemType } from "../types";
const timelineData = await getTimeline();

let perYear: Record<string, TimelineItemType[]> = {};
timelineData.forEach((d) => {
  const year = d.date.split("-")[0];
  if (!perYear[year]) {
    perYear[year] = [];
  }
  perYear[year].push(d);
});
const sortedYears = Object.keys(perYear).sort(
  (a, b) => parseInt(b) - parseInt(a),
);

// Group years by decade
let perDecade: Record<string, string[]> = {};
sortedYears.forEach((year) => {
  const decade = `${year.slice(0, 3)}0s`;
  if (!perDecade[decade]) {
    perDecade[decade] = [];
  }
  perDecade[decade].push(year);
});
const sortedDecades = Object.keys(perDecade).sort(
  (a, b) => parseInt(b) - parseInt(a),
);
---

<div id="timeline" class="max-w-2xl m-auto text-left">
  <nav class="year-nav">
    {sortedDecades.map((decade) => (
      <div class="decade-row">
        {perDecade[decade].map((year) => (
          <a href={`#year-${year}`} class="year-chip" data-year={year}>{year}</a>
        ))}
      </div>
    ))}
  </nav>

  <div class="flex flex-col gap-y-8">
    {
      sortedYears.map((year) => (
        <div id={`year-${year}`}>
          <h3 class="text-center text-lg font-bold opacity-75">{year}</h3>
          {perYear[year].map((d) => (
            <TimelineItem
              url={d.url}
              date={d.date}
              type={d.type}
              title={d.title}
              description={d.description}
            />
          ))}
        </div>
      ))
    }
  </div>
</div>

<style lang="scss">
  .year-nav {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.35em;
    margin-bottom: 2.5em;

    .decade-row {
      display: flex;
      gap: 0.4em;
    }

    .year-chip {
      display: inline-block;
      padding: 0.25em 0.7em;
      font-size: 0.85em;
      font-weight: 500;
      color: var(--c-text);
      opacity: 0.5;
      text-decoration: none;
      border-radius: 9999px;
      border: 1.5px solid transparent;
      transition: all 250ms ease;
      letter-spacing: 0.02em;

      &:hover {
        opacity: 1;
        border-color: var(--c-border);
        background: rgba(0, 0, 0, 0.04);
      }

      &.active {
        opacity: 1;
        border-color: var(--c-highlight);
        color: var(--c-highlight);
      }
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const chips = document.querySelectorAll<HTMLAnchorElement>(".year-chip");
    const sections = document.querySelectorAll<HTMLElement>("[id^='year-']");

    // Smooth scroll on click
    chips.forEach((chip) => {
      chip.addEventListener("click", (e) => {
        e.preventDefault();
        const target = document.getElementById(`year-${chip.dataset.year}`);
        if (target) {
          target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });

    // Highlight active year on scroll
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const year = entry.target.id.replace("year-", "");
          const chip = document.querySelector<HTMLAnchorElement>(
            `.year-chip[data-year="${year}"]`,
          );
          if (chip) {
            chip.classList.toggle("active", entry.isIntersecting);
          }
        });
      },
      { rootMargin: "-20% 0px -70% 0px" },
    );

    sections.forEach((section) => observer.observe(section));
  });
</script>
